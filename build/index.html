<!DOCTYPE html><html><head><meta charset="utf-8"><link rel="stylesheet" href="./styles/main.css"><style type="text/css">body{align-items:center;background:#222;background-color:#000;color:#eee;font-family:sans-serif;height:100vh;justify-content:center;margin:0;overflow:hidden;width:100vw}body,body.loading{display:flex}#canvas{background:#333}#clear,#over,#ready{color:#fff;font-size:30px;position:absolute;text-align:center}p{font-size:15px;font-weight:lighter}</style></head><body class="loading"><canvas id="canvas" width="600" height="600"></canvas><div id="ready"><h1>Back Attacker</h1><p>press Enter to start...</p></div><div id="over" style="display: none"><h1>Game Over...</h1><p>press Enter to restart...</p></div><div id="clear" style="display: none"><h1>Stage Clear !!</h1><p>press Enter to next</p></div><script type="text/javascript">!function(t){var i={};function e(s){if(i[s])return i[s].exports;var h=i[s]={i:s,l:!1,exports:{}};return t[s].call(h.exports,h,h.exports,e),h.l=!0,h.exports}e.m=t,e.c=i,e.d=function(t,i,s){e.o(t,i)||Object.defineProperty(t,i,{enumerable:!0,get:s})},e.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},e.t=function(t,i){if(1&i&&(t=e(t)),8&i)return t;if(4&i&&"object"==typeof t&&t&&t.__esModule)return t;var s=Object.create(null);if(e.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:t}),2&i&&"string"!=typeof t)for(var h in t)e.d(s,h,function(i){return t[i]}.bind(null,h));return s},e.n=function(t){var i=t&&t.__esModule?function(){return t.default}:function(){return t};return e.d(i,"a",i),i},e.o=function(t,i){return Object.prototype.hasOwnProperty.call(t,i)},e.p="",e(e.s=3)}([function(t,i,e){var s,h,o;h=[i],void 0===(o="function"==typeof(s=function(t){var i=440*Math.pow(Math.pow(2,1/12),-9),e=/^[0-9.]+$/,s=/\s+/,h=/(\d+)/,o={};function n(t){var i=t.split(s);this.frequency=n.getFrequency(i[0])||0,this.duration=n.getDuration(i[1])||0}function r(t,i,e){this.ac=t||new AudioContext,this.createFxNodes(),this.tempo=i||120,this.loop=!0,this.smoothing=0,this.staccato=0,this.notes=[],this.push.apply(this,e||[])}"B#-C|C#-Db|D|D#-Eb|E-Fb|E#-F|F#-Gb|G|G#-Ab|A|A#-Bb|B-Cb".split("|").forEach(function(t,i){t.split("-").forEach(function(t){o[t]=i})}),n.getFrequency=function(t){var e=t.split(h),s=o[e[0]],n=(e[1]||4)-4,r=i*Math.pow(Math.pow(2,1/12),s);return r*Math.pow(2,n)},n.getDuration=function(t){return e.test(t)?parseFloat(t):t.toLowerCase().split("").reduce(function(t,i){return t+("w"===i?4:"h"===i?2:"q"===i?1:"e"===i?.5:"s"===i?.25:0)},0)},r.prototype.createFxNodes=function(){var t=this.gain=this.ac.createGain();return[["bass",100],["mid",1e3],["treble",2500]].forEach(function(i,e){(e=this[i[0]]=this.ac.createBiquadFilter()).type="peaking",e.frequency.value=i[1],t.connect(t=e)}.bind(this)),t.connect(this.ac.destination),this},r.prototype.push=function(){return Array.prototype.forEach.call(arguments,function(t){this.notes.push(t instanceof n?t:new n(t))}.bind(this)),this},r.prototype.createCustomWave=function(t,i){i||(i=t),this.waveType="custom",this.customWave=[new Float32Array(t),new Float32Array(i)]},r.prototype.createOscillator=function(){return this.stop(),this.osc=this.ac.createOscillator(),this.customWave?this.osc.setPeriodicWave(this.ac.createPeriodicWave.apply(this.ac,this.customWave)):this.osc.type=this.waveType||"square",this.osc.connect(this.gain),this},r.prototype.scheduleNote=function(t,i){var e=60/this.tempo*this.notes[t].duration,s=e*(1-(this.staccato||0));return this.setFrequency(this.notes[t].frequency,i),this.smoothing&&this.notes[t].frequency&&this.slide(t,i,s),this.setFrequency(0,i+s),i+e},r.prototype.getNextNote=function(t){return this.notes[t<this.notes.length-1?t+1:0]},r.prototype.getSlideStartDelay=function(t){return t-Math.min(t,60/this.tempo*this.smoothing)},r.prototype.slide=function(t,i,e){var s=this.getNextNote(t),h=this.getSlideStartDelay(e);return this.setFrequency(this.notes[t].frequency,i+h),this.rampFrequency(s.frequency,i+e),this},r.prototype.setFrequency=function(t,i){return this.osc.frequency.setValueAtTime(t,i),this},r.prototype.rampFrequency=function(t,i){return this.osc.frequency.linearRampToValueAtTime(t,i),this},r.prototype.play=function(t){return t="number"==typeof t?t:this.ac.currentTime,this.createOscillator(),this.osc.start(t),this.notes.forEach(function(i,e){t=this.scheduleNote(e,t)}.bind(this)),this.osc.stop(t),this.osc.onended=this.loop?this.play.bind(this,t):null,this},r.prototype.stop=function(){return this.osc&&(this.osc.onended=null,this.osc.disconnect(),this.osc=null),this},t.Note=n,t.Sequence=r})?s.apply(i,h):s)||(t.exports=o)},function(t,i,e){},,function(t,i,e){"use strict";e.r(i);const s=10,h=0,o=1,n=2,r=3,a=4,c=5,l=6,y=16,d=32,u=y*d,p=1,f=0,m=1,x=2,g=3,v="rgba(255, 255, 255,0.2)",w="yellow",b="rgb(139,0,0)",k="black",S="./assets/player.png",A="./assets/enemy_top.png",T="./assets/enemy_body.png";function D(t,i){return Math.random()*(i-t)+t}function E(t,i){return t=Math.ceil(t),i=Math.floor(i)+1,Math.floor(Math.random()*(i-t))+t}function F(t,i){const e=document.createElement("canvas");return e.width=t,e.height=i,{canvas:e,context:e.getContext("2d")}}function _(t,i){return t.map(({x:t,y:e,w:s,h:h})=>({x:t*i,y:e*i,w:s*i,h:h*i}))}function B(t){return document.getElementById(t)}const M=Math.PI;function C(t){return t*M/180}function I(t){const i=new Image;return i.src=t,i}function q(t,i){return Math.abs(t-i)<=2}const P=F(u,u),O=P.canvas,N=P.context;function X(t,i){t.save(),t.beginPath(),t.fillStyle=i}function R(t){t.restore()}function Y(t,i,e){const s=E(0,3);if(2===s||3===s)return;const h=E(0,10)%2==0?1:-1,o=D(5,50)*h,n=D(5,20),r=D(4,6)*h;i+=h,t.beginPath(),t.moveTo(i,e),t.lineTo(i+r,e),t.lineTo(i+o,e-n),t.closePath(),t.fill()}const G=20,K=60;function H(t,i,e,s,h){if(s<=0){for(let s=0;s<10;s++)Y(t,i,e+2);return}const o=D(G+10*s,K+10*s);t.rect(i-1,e+2,h+1,2);const n=E(0,10);for(let s=0;s<n;s++)Y(t,i,e+2);t.rect(i,e-o,h,o),t.fill(),H(t,i,e-o-6,s-1,h)}function V(t,i){X(t,`rgba(${20+i}, ${30+i}, ${30+i}, 0.78)`);for(let i=0;i<512;i+=10)E(0,5)<3&&H(t,i+E(-10,10),512,E(3,6),E(3,6));R(t)}function z(t){if(N.clearRect(0,0,u,u),V(N,10),V(N,0),t){const i=_(t.filter(({type:t})=>"block"===t),y);!function(t,i){X(t,"black"),i.forEach(({x:i,y:e,w:s,h:h})=>{t.rect(i,e,s,h),t.fill()}),R(t)}(N,i),function(t,i){X(t,"rgba(20, 30, 30, 0.78)"),i.forEach(({x:i,y:e,w:s})=>{t.rect(i,e,s,5),t.fill();for(let h=i;h<i+s;h+=6)t.rect(h,e+2,2,5),t.fill()}),R(t)}(N,i)}return I(O.toDataURL())}const j=({type:t})=>"block"===t,W=t=>t/y|0,$=t=>_(t.filter(j),y).reduce((t,i)=>[...t,...(({x:t,y:i,w:e,h:s})=>{const h=[],o=[[t,i],[t+e,i],[t+e,i+s],[t,i+s]];for(let t=0,i=o.length;t<i;t++){const e=(t+1)%i;h.push({start:{x:o[t][0],y:o[t][1]},end:{x:o[e][0],y:o[e][1]}})}return h})(i)],[]),L=t=>{const i=function(t,i){return Array.from({length:t}).map(()=>Array.from({length:t}).map(()=>i))}(d,0);return t.filter(j).forEach(({x:t,y:e,w:s,h:h})=>(function(t,[i,e],[s,h],o){for(let n=i;n<e;n++)for(let i=s;i<h;i++)o(t,n,i)})(i,[t,t+s],[e,e+h],(t,i,e)=>t[i][e]=p)),i};var U=class{constructor(){this.x=0,this.y=0,this.img=z(null)}load(t){this.edges=$(t),this.blocks=L(t),this.img=z(t)}getOuterMost({x:t,y:i,width:e,height:s},h){const c=W(t+e/2),l=W(i+s/2);switch(h){case r:for(let t=c;t>=0;t--)if(this.blocks[t][l]===p)return{x:(t+1)*y,y:i};return{x:0,y:i};case o:for(let i=l;i>=0;i--)if(this.blocks[c][i]===p)return{x:t,y:(i+1)*y};return{x:t,y:0};case n:for(let i=l;i<d;i++)if(this.blocks[c][i]===p)return{x:t,y:i*y-s};return{x:t,y:u-s};case a:for(let t=c;t<d;t++)if(this.blocks[t][l]===p)return{x:t*y-e,y:i};return{x:u-e,y:i}}}hasBlockAt(t,i){return t<0||i<0||t>=u||i>=u||this.blocks[W(t)][W(i)]===p}renderReady(t){this.x+=.5,this.x>=u-1&&(this.x=0),t.drawImage(this.img,0,0,u-this.x,u,this.x,0,u-this.x,u),t.drawImage(this.img,u-this.x,0,this.x,u,0,0,this.x,u)}render(t){t.drawImage(this.img,0,0)}};var J={player:{x:0,y:29},map:[{type:"block",x:0,y:31,w:32,h:1},{type:"block",x:0,y:0,w:32,h:1},{type:"block",x:16,y:29,w:2,h:3},{type:"block",x:0,y:23,w:20,h:2},{type:"block",x:4,y:16,w:28,h:2},{type:"block",x:18,y:21,w:2,h:2}],enemies:[{x:20,y:29,cmd:[{action:a,until:{x:28}},{action:h,until:{time:50}},{action:l,until:{offset:-180}},{action:r,until:{x:22}},{action:h,until:{time:50}},{action:c,until:{offset:0}}]},{x:5,y:21,cmd:[{action:r,until:{x:3}},{action:h,until:{time:100}},{action:c,until:{offset:0}},{action:a,until:{x:10}},{action:h,until:{time:100}},{action:l,until:{offset:-180}}]}]};var Q={player:{x:0,y:29},map:[{type:"block",x:0,y:31,w:32,h:1},{type:"block",x:0,y:0,w:32,h:1}],enemies:[{x:20,y:29,cmd:[{action:a,until:{x:28}},{action:h,until:{time:50}},{action:l,until:{offset:-180}},{action:r,until:{x:22}},{action:h,until:{time:50}},{action:c,until:{offset:0}}]}]};var Z=function(t){switch(t){case 1:return J;case 2:return Q}};const tt={},it={};var et={loadImage:function(t,i){tt[t]||(tt[t]=I(i))},draw:function(t,i,e,s,h,o,n,r,a,c){t.drawImage(tt[i],e,s,h,o,n,r,a,c)},loadAudio:function(t,i){it[t]||(it[t]=new Audio(i))},playAudio:function(t){it[t].paused&&it[t].play()}};var st=class{constructor(t,i,e,s,h,o,n){et.loadImage(t,i),this.id=t,this.sh=n/e|0,this.sw=o,this.sy=0,this.sx=0,this.x=s,this.y=h,this.isFlipHorizontal=!1,this.isFlipVertical=!1,this.angleDeg=0,this.offsetY=0,this.offsetX=0}setFrame(t){this.sy=t*this.sh}flipHorizontal(t){this.isFlipHorizontal=t}flipVertical(t){this.isFlipVertical=t}rotate(t){this.angleDeg=t}render(t){t.save(),t.translate(this.x+this.sw/2+this.offsetX,this.y+this.sh/2+this.offsetY),t.rotate(C(this.angleDeg));const i=this.isFlipHorizontal?-1:1,e=this.isFlipVertical?-1:1;t.scale(i,e),et.draw(t,this.id,this.sx,this.sy,this.sw,this.sh,-this.sw/2-this.offsetX,-this.sh/2-this.offsetY,this.sw,this.sh),t.restore()}};var ht=class{constructor(t,i=30,e=k,s=3,h=5,o=10){this.time=i,this.color=e,this.alive=!1,this.particles=Array.from({length:t},()=>({radius:D(h,o),xSpeed:D(-s,s),ySpeed:D(-s,s/3),time:D(20,this.time),x:0,y:0}))}init(){this.time=30,this.alive=!1}generate(t,i){this.alive||(this.alive=!0,this.particles.forEach(e=>{e.x=t,e.y=i}))}update(t){this.alive&&(this.time-=t,this.time<0&&(this.alive=!1,this.time=30),this.particles.forEach(t=>{t.x+=t.xSpeed,t.y+=t.ySpeed}))}render(t){this.alive&&(t.fillStyle=this.color,this.particles.forEach(i=>{t.beginPath(),t.arc(i.x,i.y,i.radius,0,2*Math.PI),t.fill()}))}};var ot=class{constructor(t,i,e){this.velocity=0,this.maxSpeed=20,this.accel=1.5,this.map=e,this.width=32,this.height=32,this.x=t,this.y=i,this.sprite=new st("player",S,3,t,i,32,96),this.scatter=new ht(30),this.attackedScatter=new ht(10,.5,k,5,2,4),this._leftTop={x:this.x,y:this.y},this._rightTop={x:this.x+this.width,y:this.y},this._leftBottom={x:this.x,y:this.y+this.height},this.rightBottom={x:this.x+this.width,y:this.y+this.height},this.edges=[[this._leftTop,this._rightTop],[this._rightTop,this.rightBottom],[this.rightBottom,this._leftBottom],[this._leftBottom,this._leftTop]],this.init(t,i)}init(t,i){this.hp=u,this.x=t,this.y=i,this.dx=t,this.dy=i,this.isAlive=!0,this.moving=h,this.updateEdges(),this.stop(),this.attackedScatter.init(),this.scatter.init()}updateEdges(){this._leftTop.x=this.x,this._leftTop.y=this.y,this._rightTop.x=this.x+this.width,this._rightTop.y=this.y,this._leftBottom.x=this.x,this._leftBottom.y=this.y+this.height,this.rightBottom.x=this.x+this.width,this.rightBottom.y=this.y+this.height}attacked(){this.hp-=16,this.attackedScatter.generate(this.x+this.width/2,this.y+this.height/2),this.hp<0&&(this.hp=0)}update(t){if(!this.isAlive)return this.scatter.generate(this.x,this.y),void this.scatter.update();this.attackedScatter.update(t),this.updateEdges();const{maxSpeed:i,accel:e,dx:s,dy:c}=this,l=e*t*(this.moving===o||this.moving===r?-1:1);this.moving!==h&&(this.velocity+=l),this.velocity>i?this.velocity=i:this.velocity<-i&&(this.velocity=-i);const y=this.velocity*t;this.moving===o||this.moving===n?(this.y+=y,this.moving===o?this.y<c&&(this.y=c,this.stop()):this.moving===n&&this.y>c&&(this.y=c,this.stop())):this.moving!==r&&this.moving!==a||(this.x+=y,this.moving===r?this.x<s&&(this.x=s,this.stop()):this.moving===a&&this.x>s&&(this.x=s,this.stop()))}stop(){this.velocity=0,this.moving=h,this.dx=this.x,this.dy=this.y;let t=!1,i=0;this.map.hasBlockAt(this.x+this.width/2,this.y+this.height+4)?t=!1:this.map.hasBlockAt(this.x+this.width/2,this.y-4)?t=!0:this.map.hasBlockAt(this.x-4,this.y+this.height/2)?i=90:this.map.hasBlockAt(this.x+this.width+4,this.y+this.height/2)&&(i=-90),this.sprite.flipVertical(t),this.sprite.rotate(i)}move(t){if(this.moving===h){const{x:i,y:e}=this.map.getOuterMost(this,t);this.dx=i,this.dy=e,this.moving=t}}render(t){this.isAlive?(t.beginPath(),this.sprite.x=this.x,this.sprite.y=this.y,this.sprite.render(t),t.fill(),t.stroke(),this.attackedScatter.render(t)):this.scatter.render(t)}};function nt(t,i,e=1){let s=i[0].x,h=i[1].x,o=i[0].y,n=i[1].y;return s>h&&([s,h]=[h,s]),o>n&&([o,n]=[n,o]),t.x>=s-e&&t.x<=h+e&&t.y>=o-e&&t.y<=n+e}function rt(t,i){let e=t[1].y-t[0].y,s=t[0].x-t[1].x,h=e*t[0].x+s*t[0].y,o=i[1].y-i[0].y,n=i[0].x-i[1].x,r=o*i[0].x+n*i[0].y,a=e*n-o*s;if(0!==a){let c={x:(n*h-s*r)/a,y:(e*r-o*h)/a};if(nt(c,t,1)&&nt(c,i,1))return c}}function at(t,i,e){if(!i)return e;const s=t.x-i.x,h=t.y-i.y,o=s*s+h*h,n=t.x-e.x,r=t.y-e.y;return o>n*n+r*r?e:i}var ct=class{constructor(t,i,e=2,s,h,o,n){this.origin={x:t,y:i},this.gap=e,this.mapEdges=s,this.offsetDeg=o,this.angleDeg=h,this.radius=n}getIntersectionRange(t){let i,e;for(let s=0,h=this.rayEnds.length;s<h;s++)for(let h=0,o=t.length;h<o;h++){let o=rt([this.origin,this.rayEnds[s]],t[h]);o&&e&&(e=o),o&&!i&&(i=o,e=o)}return i?[i,e]:null}update(t,i,e){this.offsetDeg=e,this.origin.x=t,this.origin.y=i;const s=this.offsetDeg+this.angleDeg/2;let h=0,o=this.offsetDeg-this.angleDeg/2;for(this.rayEnds=[],this.rayEnds.length=this.angleDeg/this.gap|0;o<s;){const t=C(o),i={x:this.origin.x+Math.cos(t)*this.radius,y:this.origin.y+Math.sin(t)*this.radius};for(let t=0,e=this.mapEdges.length;t<e;t++){const e=rt([this.origin,i],[this.mapEdges[t].start,this.mapEdges[t].end]);this.rayEnds[h]=at(this.origin,this.rayEnds[h],e||i)}o+=this.gap,h++}}render(t){t.fillStyle=v,t.beginPath(),t.moveTo(this.origin.x,this.origin.y),this.rayEnds.forEach(i=>i&&t.lineTo(i.x,i.y)),t.closePath(),t.fill()}};var lt=class{constructor(){this.liveTime=0}shot(t,i,e,s){this.liveTime<=0&&(this.liveTime=5,this.originX=t,this.originY=i,this.targetX=e,this.targetY=s)}update(t){this.liveTime>0?this.liveTime-=t:this.liveTime=0}render(t){if(this.liveTime>0){t.beginPath(),t.strokeStyle=w;for(let i=0;i<5;i++)t.moveTo(this.originX,this.originY),t.lineTo(this.originX+D(-10,10),this.originY+D(-10,10));t.moveTo(this.originX,this.originY),t.lineTo(this.targetX,this.targetY);for(let i=0;i<5;i++)t.moveTo(this.targetX,this.targetY),t.lineTo(this.targetX+D(-10,10),this.targetY+D(-10,10));t.stroke()}}};var yt=class{constructor(t,i,e,s,h){this.bodySprite=new st("enemyBody",T,3,t,i,32,72),this.headSprite=new st("enemyHead",A,1,t,i,32,16),this.frameIndex=0,this.frameTime=0,this.x=t,this.y=i,this.speed=.7,this.map=e,this.width=32,this.height=32,this.cmd=s,this.cmdIndex=0,this.offset=0,this.timer=0,this.game=h,this.vision=new ct(this.x,this.y,2,this.map.edges,30,this.offset,1e3),this.bullet=new lt,this.isAttacking=!1,this.isAlive=!0,this.scatter=new ht(20)}update(t){if(!this.isAlive)return void this.scatter.update(t);const i=this.game.player;this.x<i.x+i.width&&this.x+this.width>i.x&&this.y<i.y+i.height&&this.y+this.height>i.y&&(this.isAlive=!1,et.playAudio("hit"),this.scatter.generate(this.x,this.y)),this.vision.update(this.x+this.width/2+2,this.y,this.offset);let e=this.offset%360;e>0&&(e-=360),e<-90?(this.headSprite.rotate(e+180),this.headSprite.flipVertical(!1),this.headSprite.flipHorizontal(!1),this.bodySprite.flipHorizontal(!1),this.bodySprite.offsetX=0):(this.headSprite.flipVertical(!1),this.headSprite.flipHorizontal(!0),this.headSprite.rotate(e),this.bodySprite.flipHorizontal(!0),this.bodySprite.offsetX=5),this.headSprite.offsetY=8,this.headSprite.offsetX=5;let s=this.vision.getIntersectionRange(i.edges);if(s&&i.isAlive){this.isAttacking=!0;const t=(s[0].x+s[1].x)/2,i=(s[0].y+s[1].y)/2,e=C(this.offset);this.bullet.shot(this.x+this.width/2+21*Math.cos(e),this.y+7+21*Math.sin(e),t,i),et.playAudio("shot")}else this.isAttacking=!1;if(this.isAttacking){const t=i.x+i.width/2,e=i.y+i.height/2-this.y,s=t-this.x;this.offset=function(t){return 180*t/M}(Math.atan2(e,s)),i.attacked()}this.isAttacking||this.doCmd(t),this.bullet.update(t),this.frameTime+=t,this.frameTime>10&&(this.frameTime=0,this.frameIndex++),this.frameIndex>=3&&(this.frameIndex=0),this.bodySprite.setFrame(this.frameIndex)}doCmd(t){const{action:i,until:e}=this.cmd[this.cmdIndex];let s=!1;const y=this.speed*t;switch(i){case a:this.x+=y,this.x>16*e.x&&(this.x=16*e.x,s=!0);break;case r:this.offset=-180,this.x-=y,this.x<16*e.x&&(this.x=16*e.x,s=!0);break;case n:this.y-=y,this.y<16*e.y&&(this.y=16*e.y,s=!0);break;case o:this.y+=y,this.y>16*e.y&&(this.y=16*e.y,s=!0);break;case h:this.timer+=t,this.timer>e.time&&(s=!0);break;case l:case c:this.offset+=e.offset-this.offset<0?-1:1,q(this.offset,e.offset)&&(this.offset=e.offset,s=!0)}s&&(this.timer=0,this.cmdIndex++,this.cmdIndex>=this.cmd.length&&(this.cmdIndex=0)),this.bodySprite.x=this.x,this.bodySprite.y=this.y+8,this.headSprite.x=this.x,this.headSprite.y=this.y-4}draw(t,i){this.isAlive?(this.headSprite.render(t),this.bodySprite.render(t),this.bullet.render(t),this.vision.render(i)):this.scatter.render(t)}};var dt=new function(){this._keymap={38:o,40:n,37:r,39:a,13:s},this._onKeyDown={},document.addEventListener("keydown",t=>{t.preventDefault();const i=this._keymap[t.keyCode];this._onKeyDown[i]&&this._onKeyDown[i]()}),this.on=(({key:t,onKeyDown:i})=>(this._onKeyDown[t]=i,this))};var ut=class{constructor(){}render(t){t.save(),t.beginPath(),t.fillStyle=b,t.rect(0,0,gt.player.hp,5),t.fill(),t.restore()}},pt=e(0),ft=e.n(pt),mt=new AudioContext,xt=new ft.a.Sequence(mt,240,["Gb4  w","B3  h","Db4  h","D4  e","E4  e","D4  e","C4  h","B3  h","Gb4  w","B3  h","Db4  h","D4  e","E4  e","D4  e","F4  h","G4  h","Gb4  w","B3  h","Db4  h","D4  e","E4  e","D4  e","C4  h","B3  h","Gb4  w","G4  h","F4  h","E4  w","D4  h","E4  h"]);xt.staccato=.55,xt.waveType="sawtooth",xt.gain.gain.value=.05,xt.loop=!1;var gt=new class{constructor(){this.canvas=B("canvas"),this.canvas.width=u,this.canvas.height=u,this.ctx=this.canvas.getContext("2d");const t=F(u,u);this.novCanvas=t.canvas,this.novCtx=t.context,this.nextms=0,this.input=dt,this.state=f,this.stageNum=1}init(){et.loadAudio("move","./assets/move.mp3"),et.loadAudio("hit","./assets/hit.mp3"),et.loadAudio("shot","./assets/shot.mp3"),this.map=new U(this.ctx),this.player=new ot(u/2-16,u-32,this.map),this.input.on({key:s,onKeyDown:()=>{switch(this.state){case f:B("ready").style.display="none",this.load(this.stageNum),this.state=m,xt.play();break;case m:break;case g:B("over").style.display="none",this.load(this.stageNum),this.state=m;break;case x:B("clear").style.display="none",this.stageNum++,this.load(this.stageNum),this.state=m}}})}load(t){const i=Z(t);this.map.load(i.map),this.player.init(i.player.x*y,i.player.y*y),this.enemies=i.enemies.map(({x:t,y:i,cmd:e})=>new yt(t*y,i*y,this.map,e,this)),this.hud=new ut,et.loadImage("enemyTop",A),this.input.on({key:o,onKeyDown:()=>{et.playAudio("move"),this.player.move(o)}}).on({key:n,onKeyDown:()=>{et.playAudio("move"),this.player.move(n)}}).on({key:r,onKeyDown:()=>{et.playAudio("move"),this.player.move(r)}}).on({key:a,onKeyDown:()=>{et.playAudio("move"),this.player.move(a)}})}update(t){const i=t/1e3*60;this.player.update(i),this.enemies.forEach(t=>t.update(i)),this.enemies.every(t=>!t.isAlive)&&this.state===m&&this.stageClear()}start(){window.requestAnimationFrame(this.render.bind(this))}renderReady(t){this.ctx.clearRect(0,0,u,u),this.map.renderReady(this.ctx),this.player.render(this.ctx)}renderPlaying(t){let i=t-this.nextms;this.nextms=t,this.update(i),this.ctx.clearRect(0,0,u,u),this.map.render(this.ctx),this.player.render(this.ctx),this.hud.render(this.ctx),this.novCtx.clearRect(0,0,u,u),this.novCtx.fillStyle="rgba(0,0,0,0.4)",this.novCtx.fillRect(0,0,u,u),this.enemies.forEach(t=>t.draw(this.ctx,this.novCtx)),this.ctx.save(),this.ctx.globalCompositeOperation="darken",this.ctx.drawImage(this.novCanvas,0,0),this.ctx.restore(),this.player.hp<=0&&this.state===m&&this.gameOver()}render(t){this.state===f?this.renderReady(t):this.state!==m&&this.state!==g&&this.state!==x||this.renderPlaying(t),window.requestAnimationFrame(this.render.bind(this))}gameOver(){this.state=g,this.player.isAlive=!1,B("over").style.display="block"}stageClear(){this.state=x,B("clear").style.display="block"}};gt.init(),gt.start();e(1)}]);</script></body></html>